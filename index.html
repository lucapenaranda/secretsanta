<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #b33939; --green: #218c74; }
        body { font-family: sans-serif; background: #1a472a; color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .card { background: white; color: #333; padding: 30px; border-radius: 15px; width: 350px; text-align: center; border: 5px solid var(--red); position: relative; z-index: 10; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: var(--red); color: white; margin-top: 10px; }
        .hidden { display: none; }
        .group-item { background: #f1f2f6; padding: 12px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--green); }
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1; }
    </style>
</head>
<body>
<canvas id="snow"></canvas>
<div class="card">
    <div id="view-login">
        <h1 style="color:var(--red)">üéÖ Secret Santa</h1>
        <input type="text" id="in-name" placeholder="Ton Pr√©nom">
        <input type="password" id="in-pass" placeholder="Mot de passe">
        <button class="btn" onclick="doLogin()">ENTRER</button>
    </div>
    <div id="view-main" class="hidden">
        <h2 id="txt-welcome">Salut !</h2>
        <input type="text" id="in-group-name" placeholder="Nom du groupe">
        <button class="btn" onclick="doCreateGroup()">Cr√©er le groupe</button>
        <div id="list-groups" style="margin-top:20px">Chargement...</div>
    </div>
    <div id="view-group" class="hidden">
        <button onclick="showMain()" style="cursor:pointer; border:none; background:none; color:var(--red); font-weight:bold;">‚Üê Retour</button>
        <h2 id="txt-group-title">Groupe</h2>
        <div id="list-participants" style="margin: 15px 0; font-style: italic; color:#666;"></div>
        <button class="btn" onclick="doJoin()" style="background:var(--green)">M'inscrire au tirage</button>
        <button class="btn" onclick="doReveal()" style="margin-top: 15px; background: #e67e22;">üéÅ Voir ma cible</button>
        <div id="res-target" style="font-weight:bold; color:var(--green); margin-top:15px"></div>
    </div>
</div>

<script>
    const S_URL = 'https://reeezxhcvsmcurodqxyw.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZWV6eGhjdnNtY3Vyb2RxeXl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1Mzc4MzIsImV4cCI6MjA1MDEwOTgzMn0.sV_S_nL6i915LIn5InV6eGhjdnN0Y3Vyb2RxeXl3';
    
    const sb = supabase.createClient(S_URL, S_KEY);
    let myName = "", myPass = "", currentGid = null;

    async function doLogin() {
        myName = document.getElementById('in-name').value;
        myPass = document.getElementById('in-pass').value;
        if(!myName || !myPass) return alert("Remplis tout !");
        document.getElementById('txt-welcome').innerText = "Salut " + myName + " !";
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
        loadGroups();
    }

    async function loadGroups() {
        const { data } = await sb.from('groups').select('*');
        const cont = document.getElementById('list-groups');
        cont.innerHTML = (data && data.length) ? "" : "Aucun groupe cr√©√©.";
        if(data) data.forEach(g => {
            cont.innerHTML += `<div class="group-item"><span>${g.name}</span><button onclick="openGroup('${g.id}', '${g.name}')" style="background:var(--green); color:white; border:none; padding:5px; border-radius:5px; cursor:pointer">Entrer</button></div>`;
        });
    }

    async function doCreateGroup() {
        const n = document.getElementById('in-group-name').value;
        const { error } = await sb.from('groups').insert([{ name: n }]);
        if(error) alert("Erreur : V√©rifie le SQL dans Supabase.");
        else loadGroups();
    }

    async function openGroup(id, name) {
        currentGid = id;
        document.getElementById('view-main').classList.add('hidden');
        document.getElementById('view-group').classList.remove('hidden');
        document.getElementById('txt-group-title').innerText = name;
        loadParticipants();
    }

    function showMain() {
        document.getElementById('view-group').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
        loadGroups();
    }

    async function doJoin() {
        const { error } = await sb.from('participants').insert([{ group_id: currentGid, name: myName, user_password: myPass }]);
        if(error) alert("D√©j√† inscrit !");
        loadParticipants();
    }

    async function loadParticipants() {
        const { data } = await sb.from('participants').select('name').eq('group_id', currentGid);
        document.getElementById('list-participants').innerText = "Inscrits : " + (data ? data.map(p => p.name).join(', ') : "");
    }

    async function doReveal() {
        const { data } = await sb.from('participants').select('*').eq('group_id', currentGid);
        if(!data || data.length < 3) return alert("Besoin de 3 personnes !");
        let list = data.map(p => p.name).sort();
        let targets = [...list]; targets.push(targets.shift());
        const idx = list.indexOf(myName);
        document.getElementById('res-target').innerText = "Cadeau pour : " + targets[idx];
    }

    // Neige
    const canvas = document.getElementById('snow'); const ctx = canvas.getContext('2d');
    let flakes = [];
    function init() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; flakes = []; for(let i=0; i<100; i++) flakes.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, d: Math.random()+0.5}); }
    function draw() { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "white"; ctx.beginPath(); flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); f.y += f.d; if(f.y > canvas.height) f.y = -10; }); ctx.fill(); requestAnimationFrame(draw); }
    init(); draw();
</script>
</body>
</html>
