<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa - La Maison des Cadeaux</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // --- 1. CONFIGURATION UNIQUE ---
    // V√©rifie bien qu'il n'y a qu'une seule d√©claration de 'const supabase'
    const supabaseUrl = 'TON_URL_ICI';
    const supabaseKey = 'TA_CLE_ANON_ICI';
    
    // Cr√©ation du client Supabase
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // --- 2. VARIABLES D'√âTAT ---
    let me = { name: "" };
    let currentGroupId = null;

    // --- 3. FONCTIONS ---
    async function login() {
        const nameInput = document.getElementById('user-name');
        if(!nameInput || !nameInput.value) return alert("Indique ton pr√©nom !");
        
        me.name = nameInput.value;
        document.getElementById('welcome-txt').innerText = "Salut " + me.name + " ! üéÑ";
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        await loadGroups();
    }

    async function loadGroups() {
        const { data, error } = await supabase.from('groups').select('*');
        if(error) {
            console.error("Erreur chargement groupes:", error);
            return;
        }
        const container = document.getElementById('groups-container');
        container.innerHTML = data.length ? "" : "Aucun groupe pour le moment.";
        data.forEach(g => {
            container.innerHTML += `
                <div class="group-item">
                    <span><strong>${g.name}</strong></span>
                    <button class="btn btn-green" style="width:auto; padding:8px 15px;" onclick="openGroup('${g.id}', '${g.name}')">Rejoindre</button>
                </div>`;
        });
    }

    async function createGroup() {
        const name = document.getElementById('group-name-input').value;
        if(!name) return;
        const { error } = await supabase.from('groups').insert([{ name }]);
        if(error) alert("Erreur lors de la cr√©ation : " + error.message);
        
        document.getElementById('group-name-input').value = "";
        await loadGroups();
    }

    async function openGroup(id, name) {
        currentGroupId = id;
        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('group-view').classList.remove('hidden');
        document.getElementById('current-group-name').innerText = name;
        document.getElementById('result-display').innerText = "";
        await loadParticipants();
    }

    function showMain() {
        document.getElementById('group-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        loadGroups();
    }

    async function joinGroup() {
        const { error } = await supabase.from('participants').insert([{ group_id: currentGroupId, name: me.name }]);
        if(error) alert("Tu es d√©j√† dans la liste ou erreur de connexion.");
        await loadParticipants();
    }

    async function loadParticipants() {
        const { data, error } = await supabase.from('participants').select('name').eq('group_id', currentGroupId);
        if(error) return console.error(error);
        document.getElementById('participants-list').innerHTML = "Inscrits : " + data.map(p => p.name).join(', ');
    }

    async function revealSecret() {
        const { data } = await supabase.from('participants').select('name').eq('group_id', currentGroupId);
        if(data.length < 3) return alert("Il faut au moins 3 participants !");
        
        let list = data.map(p => p.name).sort();
        let targets = [...list];
        targets.push(targets.shift()); 

        const idx = list.indexOf(me.name);
        if(idx === -1) return alert("Tu ne participes pas √† ce groupe !");
        
        document.getElementById('result-display').innerHTML = "Tu dois offrir √† : <br>‚≠ê " + targets[idx] + " ‚≠ê";
    }

    // --- 4. ANIMATION NEIGE (Optionnel) ---
    const canvas = document.getElementById('snow');
    if(canvas) {
        const ctx = canvas.getContext('2d');
        let width, height, flakes = [];

        function initSnow() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            flakes = [];
            for(let i=0; i<100; i++) flakes.push({x: Math.random()*width, y: Math.random()*height, r: Math.random()*3+1, d: Math.random()+0.5});
        }

        function drawSnow() {
            ctx.clearRect(0,0,width,height);
            ctx.fillStyle = "white";
            ctx.beginPath();
            flakes.forEach(f => {
                ctx.moveTo(f.x, f.y);
                ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                f.y += f.d; f.x += Math.sin(f.y/50);
                if(f.y > height) f.y = -10;
            });
            ctx.fill();
            requestAnimationFrame(drawSnow);
        }
        window.onresize = initSnow;
        initSnow(); 
        drawSnow();
    }
</script>
    // --- REMPLACE ICI ---
    const supabaseUrl = 'https://reeezxhcvsmcurodqxyw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZWV6eGhjdnNtY3Vyb2RxeHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzMwOTAsImV4cCI6MjA4MTY0OTA5MH0.Vg8ZADo1X4P9c_Rhs21jGUMThhc9MbdD3ETLZS9EDhw';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let me = { name: "" };
    let currentGroupId = null;

    async function login() {
        const name = document.getElementById('user-name').value;
        if(!name) return alert("Indique ton pr√©nom !");
        me.name = name;
        document.getElementById('welcome-txt').innerText = "Salut " + name + " ! üéÑ";
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        await loadGroups();
    }

    async function loadGroups() {
        const { data, error } = await supabase.from('groups').select('*');
        if(error) console.error(error);
        const container = document.getElementById('groups-container');
        container.innerHTML = data.length ? "" : "Aucun groupe pour le moment.";
        data.forEach(g => {
            container.innerHTML += `<div class="group-item">
                <span><strong>${g.name}</strong></span>
                <button class="btn btn-green" style="width:auto; padding:8px 15px;" onclick="openGroup('${g.id}', '${g.name}')">Rejoindre</button>
            </div>`;
        });
    }

    async function createGroup() {
        const name = document.getElementById('group-name-input').value;
        if(!name) return;
        await supabase.from('groups').insert([{ name }]);
        document.getElementById('group-name-input').value = "";
        loadGroups();
    }

    async function openGroup(id, name) {
        currentGroupId = id;
        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('group-view').classList.remove('hidden');
        document.getElementById('current-group-name').innerText = name;
        document.getElementById('result-display').innerText = "";
        loadParticipants();
    }

    function showMain() {
        document.getElementById('group-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        loadGroups();
    }

    async function joinGroup() {
        const { error } = await supabase.from('participants').insert([{ group_id: currentGroupId, name: me.name }]);
        if(error) alert("Tu es d√©j√† dans la liste !");
        loadParticipants();
    }

    async function loadParticipants() {
        const { data } = await supabase.from('participants').select('name').eq('group_id', currentGroupId);
        document.getElementById('participants-list').innerHTML = "Inscrits : " + data.map(p => p.name).join(', ');
    }

    async function revealSecret() {
        const { data } = await supabase.from('participants').select('name').eq('group_id', currentGroupId);
        if(data.length < 3) return alert("Il faut au moins 3 participants pour m√©langer !");
        
        let list = data.map(p => p.name).sort();
        let targets = [...list];
        targets.push(targets.shift()); // D√©calage simple pour le Secret Santa

        const idx = list.indexOf(me.name);
        if(idx === -1) return alert("Tu ne participes pas √† ce groupe !");
        
        document.getElementById('result-display').innerHTML = "Tu dois offrir √† : <br>‚≠ê " + targets[idx] + " ‚≠ê";
    }

    // --- ANIMATION NEIGE ---
    const canvas = document.getElementById('snow');
    const ctx = canvas.getContext('2d');
    let width, height, flakes = [];

    function initSnow() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        flakes = [];
        for(let i=0; i<100; i++) flakes.push({x: Math.random()*width, y: Math.random()*height, r: Math.random()*3+1, d: Math.random()+0.5});
    }

    function drawSnow() {
        ctx.clearRect(0,0,width,height);
        ctx.fillStyle = "white";
        ctx.beginPath();
        flakes.forEach(f => {
            ctx.moveTo(f.x, f.y);
            ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
            f.y += f.d; f.x += Math.sin(f.y/50);
            if(f.y > height) f.y = -10;
        });
        ctx.fill();
        requestAnimationFrame(drawSnow);
    }
    window.onresize = initSnow;
    initSnow(); drawSnow();
</script>
</body>
</html>
