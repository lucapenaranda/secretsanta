<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Secret Santa Pro - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Garde ton design actuel ici, j'ajoute juste les sections n√©cessaires */
        .hidden { display: none; }
        .card { max-width: 400px; margin: auto; padding: 20px; border: 2px solid #a34641; border-radius: 10px; }
        input, button { width: 100%; margin: 5px 0; padding: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1 id="main-title">üéÑ Secret Santa</h1>

    <div id="auth-section">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Mot de passe">
        <button onclick="signUp()">S'INSCRIRE</button>
        <button onclick="signIn()" style="background: #a34641; color: white;">SE CONNECTER</button>
    </div>

    <div id="group-section" class="hidden">
        <h3>Bienvenue <span id="user-display"></span></h3>
        <button onclick="showCreateGroup()">Cr√©er un nouveau groupe</button>
        <hr>
        <h4>Rejoindre un groupe existant</h4>
        <div id="available-groups"></div>
    </div>

    <div id="dashboard-section" class="hidden">
        <h3 id="group-name-display"></h3>
        <p id="participant-count"></p>
        <div id="member-list"></div>
        <button id="btn-reveal" class="hidden" onclick="revealTarget()" style="background: green; color: white;">VOIR MA CIBLE</button>
        <p id="target-display" style="font-weight: bold; font-size: 1.5em; color: #a34641;"></p>
    </div>
</div>

<script>
    // --- CONFIGURATION SUPABASE ---
    const SUPABASE_URL = "https://reeezxhcvsmcurodqxyw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZWV6eGhjdnNtY3Vyb2RxeHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzMwOTAsImV4cCI6MjA4MTY0OTA5MH0.Vg8ZADo1X4P9c_Rhs21jGUMThhc9MbdD3ETLZS9EDhw";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let currentGroupId = null;

    // --- 1. AUTHENTIFICATION ---
    async function signUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) alert(error.message); else alert("V√©rifie tes emails !");
    }

    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) alert(error.message);
        else {
            currentUser = data.user;
            showGroups();
        }
    }

    // --- 2. GESTION DES GROUPES ---
    async function showGroups() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('group-section').classList.remove('hidden');
        document.getElementById('user-display').innerText = currentUser.email;

        const { data: groups } = await supabase.from('groups').select('*');
        const container = document.getElementById('available-groups');
        container.innerHTML = groups.map(g => 
            `<button onclick="joinGroup('${g.id}')">Rejoindre ${g.name}</button>`
        ).join('');
    }

    async function showCreateGroup() {
        const name = prompt("Nom du groupe :");
        const max = prompt("Nombre de participants requis :");
        if (!name || !max) return;

        const { data, error } = await supabase.from('groups').insert([
            { name: name, max_participants: parseInt(max), creator_id: currentUser.id }
        ]).select();

        if (data) joinGroup(data[0].id);
    }

    async function joinGroup(groupId) {
        currentGroupId = groupId;
        // Inscription dans memberships
        await supabase.from('memberships').upsert({ group_id: groupId, user_id: currentUser.id });
        loadDashboard();
    }

    // --- 3. TIRAGE ET AFFICHAGE ---
    async function loadDashboard() {
        document.getElementById('group-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');

        // R√©cup√©rer infos groupe + membres
        const { data: group } = await supabase.from('groups').select('*').eq('id', currentGroupId).single();
        const { data: members } = await supabase.from('memberships').select('user_id').eq('group_id', currentGroupId);

        document.getElementById('group-name-display').innerText = group.name;
        document.getElementById('participant-count').innerText = `${members.length} / ${group.max_participants} participants`;

        // Si le groupe est complet, on permet de voir sa cible
        if (members.length >= group.max_participants) {
            document.getElementById('btn-reveal').classList.remove('hidden');
            // SEUL LE CR√âATEUR D√âCLENCHE LE TIRAGE R√âEL UNE FOIS
            if (currentUser.id === group.creator_id) {
                checkAndGenerateDraw(group, members);
            }
        }
    }

async function checkAndGenerateDraw(group, members) {
    // 1. R√©cup√©rer les profils (ID + Username) de tous les membres du groupe
    const memberIds = members.map(m => m.user_id);
    const { data: profiles } = await supabase
        .from('profiles')
        .select('id, username')
        .in('id', memberIds);

    // 2. V√©rifier si le tirage existe d√©j√† dans la table memberships
    const { data: existing } = await supabase
        .from('memberships')
        .select('target_id')
        .eq('group_id', currentGroupId)
        .not('target_id', 'is', null);

    if (existing.length === 0) {
        // 3. Lancer l'algorithme avec la logique de triche
        const draw = performLogicDraw(profiles);
        
        // 4. Enregistrer chaque affectation dans Supabase
        for (const [donorId, targetId] of Object.entries(draw)) {
            await supabase
                .from('memberships')
                .update({ target_id: targetId })
                .match({ group_id: currentGroupId, user_id: donorId });
        }
        console.log("Tirage termin√© et enregistr√© !");
    }
}

function performLogicDraw(profiles) {
    let success = false;
    let finalMap = {};
    let attempts = 0;

    while (!success && attempts < 1000) {
        attempts++;
        let donors = [...profiles];
        let receivers = [...profiles];
        let tempDraw = {};

        // --- PARTIE TRICHE : Marie -> Misstache ---
        const marie = donors.find(p => p.username === "Marie");
        const misstache = receivers.find(p => p.username === "Misstache");

        if (marie && misstache) {
            tempDraw[marie.id] = misstache.id;
            // On les retire des listes pour ne pas les r√©utiliser
            donors = donors.filter(d => d.id !== marie.id);
            receivers = receivers.filter(r => r.id !== misstache.id);
        }

        // M√©lange al√©atoire du reste
        receivers.sort(() => Math.random() - 0.5);

        let possible = true;
        for (let i = 0; i < donors.length; i++) {
            const donor = donors[i];
            const receiver = receivers[i];

            // R√®gle 1 : Pas de soi-m√™me
            if (donor.id === receiver.id) {
                possible = false;
                break;
            }

            // R√®gle 2 : Luca ne peut pas tirer Marie
            if (donor.username === "Luca" && receiver.username === "Marie") {
                possible = false;
                break;
            }

            tempDraw[donor.id] = receiver.id;
        }

        if (possible) {
            success = true;
            finalMap = tempDraw;
        }
    }
    return finalMap;
}

    async function revealTarget() {
        const { data } = await supabase.from('memberships')
            .select('target_id').match({ group_id: currentGroupId, user_id: currentUser.id }).single();
        
        // On r√©cup√®re le nom de l'utilisateur cible (via une jointure ou un select)
        document.getElementById('target-display').innerText = "Cible ID: " + data.target_id;
        // Pour afficher le vrai NOM, il faudrait une table profiles li√©e
    }
</script>
</body>
</html>
