<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa - La Maison des Secrets</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #b33939; --green: #218c74; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a472a; color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .card { background: white; color: #333; padding: 30px; border-radius: 15px; width: 380px; text-align: center; border: 5px solid var(--red); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; z-index: 10; }
        input { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: var(--red); color: white; margin-top: 10px; }
        .link-auth { display: block; margin-top: 15px; font-size: 0.8em; color: var(--red); cursor: pointer; text-decoration: underline; }
        .hidden { display: none; }
        .group-item { background: #f1f2f6; padding: 12px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--green); }
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1; }
    </style>
</head>
<body>

<canvas id="snow"></canvas>

<div class="card">
    <div id="v-auth">
        <h1 id="auth-title" style="color:var(--red)">üéÖ Connexion</h1>
        <input type="text" id="auth-name" placeholder="Ton Pr√©nom">
        <input type="password" id="auth-pass" placeholder="Mot de passe">
        <button type="button" onclick="connecter()">SE CONNECTER</button>
        <a href="#" onclick="inscrire()">Pas encore de compte ? S'inscrire</a>
    </div>

    <div id="v-main" class="hidden">
        <h2 id="welcome-msg">Salut !</h2>
        <div style="background: #f9f9f9; padding: 10px; border-radius: 10px; margin-bottom: 20px;">
            <input type="text" id="new-g-name" placeholder="Nom du groupe">
            <input type="number" id="new-g-limit" placeholder="Nombre de participants" min="3" value="3">
            <button class="btn" onclick="appCreateGroup()">Cr√©er ce groupe</button>
        </div>
        <div id="groups-list">Chargement des groupes...</div>
    </div>

    <div id="v-group" class="hidden">
        <button onclick="showMain()" style="border:none; background:none; color:var(--red); font-weight:bold; float:left; cursor:pointer;">‚Üê Retour</button>
        <br><h2 id="cur-g-title">Groupe</h2>
        <p id="cur-g-info" style="font-weight: bold; color: var(--green);"></p>
        <div id="participants-list" style="margin: 15px 0; color: #666; font-style: italic;"></div>
        <button id="btn-join" class="btn" onclick="appJoinGroup()" style="background:var(--green)">M'inscrire au tirage</button>
        <div id="reveal-zone" class="hidden">
            <p style="color: var(--red); font-weight: bold;">Groupe complet ! üéÅ</p>
            <button class="btn" onclick="appReveal()" style="background: var(--gold); color: #333;">D√âCOUVRIR MA CIBLE</button>
        </div>
        <div id="res-target" style="font-weight:bold; color:var(--green); margin-top:15px; font-size: 1.2em;"></div>
    </div>
</div>

<script>
    // 1. Initialisation : On r√©cup√®re les donn√©es ou on cr√©e des listes vides
    let participants = JSON.parse(localStorage.getItem('ss_participants')) || [];
    let assignments = JSON.parse(localStorage.getItem('ss_assignments')) || null;

    // --- FONCTION POUR S'INSCRIRE ---
    function inscrire() {
        const name = prompt("Entrez votre pr√©nom pour vous inscrire au Secret Santa :");
        if (!name) return;

        // On v√©rifie si le nom existe d√©j√†
        if (participants.find(p => p.name.toLowerCase() === name.toLowerCase())) {
            alert("Ce nom est d√©j√† inscrit !");
            return;
        }

        participants.push({ name: name.trim() });
        localStorage.setItem('ss_participants', JSON.stringify(participants));
        alert(name + " a √©t√© ajout√© √† la liste ! (Total : " + participants.length + ")");
        
        // On efface l'ancien tirage si on ajoute quelqu'un
        localStorage.removeItem('ss_assignments');
        assignments = null;
    }

    // --- FONCTION POUR SE CONNECTER ET VOIR SON TIRAGE ---
    function connecter() {
        const inputs = document.querySelectorAll('input');
        const userName = inputs[0].value.trim(); // Le premier champ (Nom)

        if (!userName) {
            alert("Veuillez entrer votre pr√©nom dans le premier champ !");
            return;
        }

        // Si le tirage n'est pas encore fait, on le g√©n√®re MAINTENANT
        if (!assignments) {
            if (participants.length < 3) {
                alert("Il n'y a pas assez d'inscrits (minimum 3). Cliquez sur 'S'inscrire' d'abord !");
                return;
            }
            generateDraw();
        }

        // On cherche l'utilisateur (insensible √† la casse)
        const match = Object.keys(assignments).find(k => k.toLowerCase() === userName.toLowerCase());

        if (match) {
            const cible = assignments[match];
            // On remplace le contenu de la carte par le r√©sultat
            const card = document.querySelector('.card') || document.body; 
            card.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h2 style="color: #a34641;">üéÑ Mission Secr√®te üéÑ</h2>
                    <p style="font-size: 1.2em;">Bonjour <strong>${match}</strong>,</p>
                    <p>Tu dois offrir un cadeau √† :</p>
                    <h1 style="color: #2e4d32; background: #f0f0f0; padding: 10px; border-radius: 8px;">${cible}</h1>
                    <button onclick="location.reload()" style="margin-top:20px; cursor:pointer;">Retour</button>
                </div>
            `;
        } else {
            alert("Le pr√©nom '" + userName + "' n'est pas dans la liste des inscrits.");
        }
    }

    // --- L'ALGORITHME DE TIRAGE (Z√©ro doublon + Triche) ---
    function generateDraw() {
        let success = false;
        let attempts = 0;

        while (!success && attempts < 1000) {
            attempts++;
            let donors = participants.map(p => p.name);
            let receivers = [...donors];
            let tempAssignments = {};

            // R√àGLE TRICHE 1 : Marie -> Misstache
            if (donors.includes("Marie") && receivers.includes("Misstache")) {
                tempAssignments["Marie"] = "Misstache";
                donors = donors.filter(d => d !== "Marie");
                receivers = receivers.filter(r => r !== "Misstache");
            }

            // M√©lange al√©atoire des receveurs restants
            receivers.sort(() => Math.random() - 0.5);

            let possible = true;
            for (let i = 0; i < donors.length; i++) {
                let d = donors[i];
                let r = receivers[i];

                // R√àGLE TRICHE 2 : Luca != Marie + Pas de soi-m√™me
                if (d === r || (d === "Luca" && r === "Marie")) {
                    possible = false;
                    break;
                }
                tempAssignments[d] = r;
            }

            if (possible) {
                assignments = tempAssignments;
                localStorage.setItem('ss_assignments', JSON.stringify(assignments));
                success = true;
            }
        }
    }
</script>
</body>
</html>
