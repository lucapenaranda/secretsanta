<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Secret Santa de No√´l</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --red: #c0392b;
            --green: #27ae60;
            --gold: #f1c40f;
            --snow: #ecf0f1;
        }

        body {
            font-family: 'Georgia', serif;
            background: #1a472a url('https://www.transparenttextures.com/patterns/snow.png');
            color: var(--snow);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            width: 100%; max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 5px solid var(--red);
            text-align: center;
        }

        h1 { color: var(--red); font-size: 2.5em; margin-top: 0; }
        .btn {
            background: var(--red); color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            font-weight: bold; margin: 5px;
        }
        .btn-green { background: var(--green); }
        
        input {
            padding: 10px; border: 2px solid #ddd; border-radius: 5px;
            width: 70%; margin-bottom: 10px;
        }

        .group-card {
            border: 1px solid #ddd; padding: 15px; margin: 10px 0;
            border-radius: 10px; display: flex; justify-content: space-between;
            align-items: center; background: white;
        }

        .hidden { display: none; }
        .santa-icon { font-size: 3em; }
    </style>
</head>
<body>

<div class="container">
    <div id="home-view">
        <div class="santa-icon">üéÖ</div>
        <h1>Les Groupes de No√´l</h1>
        
        <div style="margin-bottom: 30px;">
            <input type="text" id="new-group-name" placeholder="Nom du nouveau groupe...">
            <button class="btn" onclick="createNewGroup()">Cr√©er un groupe</button>
        </div>

        <div id="groups-list">
            <p>Chargement des festivit√©s...</p>
        </div>
    </div>

    <div id="group-view" class="hidden">
        <button class="btn" onclick="showHome()" style="float: left;">‚Üê Retour</button>
        <h1 id="current-group-title">Groupe</h1>
        <p>Inscris-toi pour participer au tirage au sort !</p>
        
        <input type="text" id="player-name" placeholder="Ton pr√©nom">
        <button class="btn btn-green" onclick="joinGroup()">S'inscrire</button>

        <div id="participants-list" style="margin: 20px 0; font-weight: bold;"></div>
        
        <hr>
        <button class="btn" onclick="shuffleSecretSanta()">Lancer le tirage de No√´l</button>
        <div id="result-area" style="margin-top: 20px; font-size: 1.2em; color: var(--green);"></div>
    </div>
</div>

<script>
    // INITIALISATION SUPABASE
    const supabaseUrl = 'https://reeezxhcvsmcurodqxyw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZWV6eGhjdnNtY3Vyb2RxeHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzMwOTAsImV4cCI6MjA4MTY0OTA5MH0.Vg8ZADo1X4P9c_Rhs21jGUMThhc9MbdD3ETLZS9EDhw';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let currentGroupId = null;

    async function loadGroups() {
        const { data, error } = await supabase.from('groups').select('*').order('created_at', { ascending: false });
        const listDiv = document.getElementById('groups-list');
        listDiv.innerHTML = "";
        data.forEach(g => {
            listDiv.innerHTML += `
                <div class="group-card">
                    <span><strong>${g.name}</strong></span>
                    <button class="btn btn-green" onclick="openGroup('${g.id}', '${g.name}')">Rejoindre</button>
                </div>`;
        });
    }

    async function createNewGroup() {
        const name = document.getElementById('new-group-name').value;
        if (!name) return;
        await supabase.from('groups').insert([{ name }]);
        document.getElementById('new-group-name').value = "";
        loadGroups();
    }

    async function openGroup(id, name) {
        currentGroupId = id;
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('group-view').classList.remove('hidden');
        document.getElementById('current-group-title').innerText = name;
        loadParticipants();
    }

    function showHome() {
        document.getElementById('home-view').classList.remove('hidden');
        document.getElementById('group-view').classList.add('hidden');
        loadGroups();
    }

    async function joinGroup() {
        const name = document.getElementById('player-name').value;
        if (!name) return;
        await supabase.from('participants').insert([{ group_id: currentGroupId, name }]);
        document.getElementById('player-name').value = "";
        loadParticipants();
    }

    async function loadParticipants() {
        const { data } = await supabase.from('participants').select('name').eq('group_id', currentGroupId);
        document.getElementById('participants-list').innerHTML = "Participants : " + data.map(p => p.name).join(', ');
    }

    async function shuffleSecretSanta() {
        const { data: participants } = await supabase.from('participants').select('*').eq('group_id', currentGroupId);
        if (participants.length < 3) return alert("Il faut au moins 3 personnes !");

        let names = participants.map(p => p.name);
        let shuffled = [...names];
        
        // Tirage au sort
        let valid = false;
        while (!valid) {
            shuffled.sort(() => Math.random() - 0.5);
            valid = participants.every((p, i) => p.name !== shuffled[i]);
        }

        const myName = prompt("Entrez votre pr√©nom pour voir votre cible :");
        const index = names.indexOf(myName);
        if (index !== -1) {
            document.getElementById('result-area').innerHTML = `üéÑ üéÅ Tu dois faire un cadeau √† : <strong>${shuffled[index]}</strong>`;
        } else {
            alert("Tu n'es pas dans la liste !");
        }
    }

    loadGroups();
</script>
</body>
</html>
