<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa - La Maison des Secrets</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #b33939; --green: #218c74; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a472a; color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .card { background: white; color: #333; padding: 30px; border-radius: 15px; width: 380px; text-align: center; border: 5px solid var(--red); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; z-index: 10; }
        input { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: var(--red); color: white; margin-top: 10px; }
        .link-auth { display: block; margin-top: 15px; font-size: 0.8em; color: var(--red); cursor: pointer; text-decoration: underline; }
        .hidden { display: none; }
        .group-item { background: #f1f2f6; padding: 12px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--green); }
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1; }
    </style>
</head>
<body>

<canvas id="snow"></canvas>

<div class="card">
    <div id="v-auth">
        <h1 id="auth-title" style="color:var(--red)">üéÖ Connexion</h1>
        <input type="text" id="auth-name" placeholder="Ton Pr√©nom">
        <input type="password" id="auth-pass" placeholder="Mot de passe">
        <button id="btn-auth" class="btn" onclick="handleAuth()">SE CONNECTER</button>
        <span class="link-auth" id="toggle-auth" onclick="toggleAuth()">Pas encore de compte ? S'inscrire</span>
    </div>

    <div id="v-main" class="hidden">
        <h2 id="welcome-msg">Salut !</h2>
        <div style="background: #f9f9f9; padding: 10px; border-radius: 10px; margin-bottom: 20px;">
            <input type="text" id="new-g-name" placeholder="Nom du groupe">
            <input type="number" id="new-g-limit" placeholder="Nombre de participants" min="3" value="3">
            <button class="btn" onclick="appCreateGroup()">Cr√©er ce groupe</button>
        </div>
        <div id="groups-list">Chargement des groupes...</div>
    </div>

    <div id="v-group" class="hidden">
        <button onclick="showMain()" style="border:none; background:none; color:var(--red); font-weight:bold; float:left; cursor:pointer;">‚Üê Retour</button>
        <br><h2 id="cur-g-title">Groupe</h2>
        <p id="cur-g-info" style="font-weight: bold; color: var(--green);"></p>
        <div id="participants-list" style="margin: 15px 0; color: #666; font-style: italic;"></div>
        <button id="btn-join" class="btn" onclick="appJoinGroup()" style="background:var(--green)">M'inscrire au tirage</button>
        <div id="reveal-zone" class="hidden">
            <p style="color: var(--red); font-weight: bold;">Groupe complet ! üéÅ</p>
            <button class="btn" onclick="appReveal()" style="background: var(--gold); color: #333;">D√âCOUVRIR MA CIBLE</button>
        </div>
        <div id="res-target" style="font-weight:bold; color:var(--green); margin-top:15px; font-size: 1.2em;"></div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const S_URL = 'https://reeezxhcvsmcurodqxyw.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZWV6eGhjdnNtY3Vyb2RxeHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzMwOTAsImV4cCI6MjA4MTY0OTA5MH0.Vg8ZADo1X4P9c_Rhs21jGUMThhc9MbdD3ETLZS9EDhw';
    const sb = supabase.createClient(S_URL, S_KEY);

    let isLoginMode = true;
    let user = { name: "" };
    let activeGroup = { id: null, limit: 0 };

    function toggleAuth() {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? "üéÖ Connexion" : "üéÖ Inscription";
        document.getElementById('btn-auth').innerText = isLoginMode ? "SE CONNECTER" : "S'INSCRIRE";
        document.getElementById('toggle-auth').innerText = isLoginMode ? "Pas encore de compte ? S'inscrire" : "D√©j√† un compte ? Se connecter";
    }

async function handleAuth() {
    const n = document.getElementById('auth-name').value.trim();
    const p = document.getElementById('auth-pass').value.trim();
    if(!n || !p) return alert("Remplis tout !");

    console.log("Tentative avec :", n);

    if (isLoginMode) {
        const { data, error } = await sb.from('profiles').select('*').eq('name', n).eq('password', p).single();
        if (error) {
            console.error("Erreur Connexion:", error);
            return alert("Erreur : " + error.message);
        }
        enterApp(n);
    } else {
        const { data, error } = await sb.from('profiles').insert([{ name: n, password: p }]);
        if (error) {
            console.error("Erreur Inscription:", error);
            // Si l'erreur est 401 ici, c'est ta cl√© S_KEY qui est fausse
            return alert("Erreur Supabase ("+error.code+"): " + error.message);
        }
        alert("Compte cr√©√© ! Tu peux maintenant te connecter.");
        toggleAuth();
    }
}

    function enterApp(name) {
        user.name = name;
        document.getElementById('welcome-msg').innerText = "Salut " + name + " ! üéÑ";
        document.getElementById('v-auth').classList.add('hidden');
        document.getElementById('v-main').classList.remove('hidden');
        loadGroups();
    }

    // --- LOGIQUE GROUPES ---
    async function loadGroups() {
        const { data } = await sb.from('groups').select('*');
        const cont = document.getElementById('groups-list');
        cont.innerHTML = (data && data.length) ? "" : "Aucun groupe cr√©√©.";
        if(data) data.forEach(g => {
            cont.innerHTML += `<div class="group-item"><span><strong>${g.name}</strong> (${g.max_slots} pers.)</span><button class="btn" style="width:auto; margin:0; padding:5px 10px; background:var(--green);" onclick="openGroup('${g.id}', '${g.name}', ${g.max_slots})">Entrer</button></div>`;
        });
    }

    async function appCreateGroup() {
        const name = document.getElementById('new-g-name').value;
        const limit = document.getElementById('new-g-limit').value;
        if(!name || limit < 3) return alert("Nom valide et minimum 3 personnes !");
        const { error } = await sb.from('groups').insert([{ name: name, max_slots: limit }]);
        if(error) alert("Ce nom de groupe existe d√©j√†.");
        else { document.getElementById('new-g-name').value = ""; loadGroups(); }
    }

    async function openGroup(id, name, limit) {
        activeGroup = { id, name, limit };
        document.getElementById('v-main').classList.add('hidden');
        document.getElementById('v-group').classList.remove('hidden');
        document.getElementById('cur-g-title').innerText = name;
        loadParticipants();
    }

    function showMain() {
        document.getElementById('v-group').classList.add('hidden');
        document.getElementById('v-main').classList.remove('hidden');
        loadGroups();
    }

    async function loadParticipants() {
        const { data } = await sb.from('memberships').select('profile_name').eq('group_id', activeGroup.id);
        const count = data ? data.length : 0;
        document.getElementById('cur-g-info').innerText = `Participants : ${count} / ${activeGroup.limit}`;
        document.getElementById('participants-list').innerText = "Inscrits : " + (data ? data.map(m => m.profile_name).join(', ') : "");
        if(count >= activeGroup.limit) {
            document.getElementById('btn-join').classList.add('hidden');
            document.getElementById('reveal-zone').classList.remove('hidden');
        } else {
            document.getElementById('btn-join').classList.remove('hidden');
            document.getElementById('reveal-zone').classList.add('hidden');
        }
    }

    async function appJoinGroup() {
        const { error } = await sb.from('memberships').insert([{ group_id: activeGroup.id, profile_name: user.name }]);
        if(error) alert("Erreur (groupe plein ou tu es d√©j√† inscrit).");
        loadParticipants();
    }

async function appReveal() {
    // 1. R√©cup√©ration des participants
    const { data } = await sb.from('memberships').select('profile_name').eq('group_id', activeGroup.id);
    if(!data || data.length < 3) return alert("Il faut au moins 3 participants !");

    const allNames = data.map(m => m.profile_name).sort(); // Tri√© pour que le tirage soit le m√™me pour tous
    const marieName = allNames.find(n => n.toLowerCase() === "marie");
    const misstacheName = allNames.find(n => n.toLowerCase() === "misstache");

    let finalTarget = "";

    // --- LOGIQUE DE TIRAGE AVEC MISSIONS ---
    if (marieName && misstacheName) {
        if (user.name.toLowerCase() === "marie") {
            // MISSION 1 : Marie offre TOUJOURS √† Misstache
            finalTarget = misstacheName;
        } else {
            // Pour tous les autres : on cr√©e un tirage o√π Misstache n'est pas une cible
            // et Marie n'est pas un donneur (car elle a d√©j√† sa cible).
            const givers = allNames.filter(n => n.toLowerCase() !== "marie");
            const receivers = allNames.filter(n => n.toLowerCase() !== "misstache");

            const myIdx = givers.indexOf(user.name);
            // D√©calage circulaire simple sur les listes r√©duites
            finalTarget = receivers[(myIdx + 1) % receivers.length];

            // MISSION 2 : Luca ne doit PAS tomber sur Marie
            if (user.name.toLowerCase() === "luca" && finalTarget.toLowerCase() === "marie") {
                // Si Luca tombe sur Marie, on lui donne la personne suivante dans la liste des receveurs
                finalTarget = receivers[(myIdx + 2) % receivers.length];
            }
            
            // S√âCURIT√â : Anti-auto-tirage (X ne peut pas s'offrir √† X)
            if (finalTarget === user.name) {
                finalTarget = receivers[(myIdx + 2) % receivers.length];
            }
        }
    } else {
        // Tirage classique si Marie ou Misstache ne sont pas dans le groupe
        let list = [...allNames];
        let targets = [...list];
        targets.push(targets.shift());
        finalTarget = targets[list.indexOf(user.name)];
    }

    // Affichage
    document.getElementById('res-target').innerHTML = "üéÅ Ta mission : Offrir √† <br><span style='font-size:1.5em; color:var(--red)'>" + finalTarget + "</span>";
}

    // --- NEIGE ---
    const canvas = document.getElementById('snow'); const ctx = canvas.getContext('2d');
    let flakes = [];
    function init() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; flakes = []; for(let i=0; i<100; i++) flakes.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, d: Math.random()+0.5}); }
    function draw() { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "white"; ctx.beginPath(); flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); f.y += f.d; if(f.y > canvas.height) f.y = -10; }); ctx.fill(); requestAnimationFrame(draw); }
    init(); draw();
</script>
</body>
</html>
