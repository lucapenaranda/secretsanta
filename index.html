<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa - La Maison des Cadeaux</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #b33939; --green: #218c74; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a472a; color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .card { background: white; color: #333; padding: 30px; border-radius: 15px; width: 350px; text-align: center; border: 5px solid var(--red); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; z-index: 10; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: var(--red); color: white; margin-top: 10px; }
        .hidden { display: none; }
        .group-item { background: #f1f2f6; padding: 12px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--green); }
        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1; }
    </style>
</head>
<body>

<canvas id="snow"></canvas>

<div class="card">
    <div id="login-view">
        <h1 style="color:var(--red)">üéÖ Connexion</h1>
        <input type="text" id="user-name" placeholder="Ton Pr√©nom">
        <input type="password" id="user-pass" placeholder="Ton Mot de passe">
        <button class="btn" onclick="actionLogin()">ENTRER DANS LA MAISON</button>
    </div>

    <div id="main-view" class="hidden">
        <h2 id="welcome-txt">Salut !</h2>
        <input type="text" id="group-name-input" placeholder="Nom du groupe √† cr√©er">
        <button class="btn" onclick="actionCreateGroup()">Cr√©er ce groupe</button>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <div id="groups-container">Chargement des groupes...</div>
    </div>

    <div id="group-view" class="hidden">
        <button onclick="actionShowMain()" style="cursor:pointer; border:none; background:none; color:var(--red); font-weight:bold; float:left;">‚Üê Retour</button>
        <br><h2 id="current-group-name">Groupe</h2>
        <div id="participants-list" style="margin: 15px 0; font-style: italic; color:#666;"></div>
        <button class="btn" onclick="actionJoinGroup()" style="background:var(--green)">M'inscrire au tirage</button>
        <button class="btn" onclick="actionRevealSecret()" style="margin-top: 15px; background: #e67e22;">üéÅ Voir ma cible</button>
        <div id="result-display" style="font-weight:bold; color:var(--green); margin-top:15px"></div>
    </div>
</div>

<script>
    // --- CONFIGURATION UNIQUE ---
    const S_URL = 'https://reeezxhcvsmcurodqxyw.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZWV6eGhjdnNtY3Vyb2RxeXl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1Mzc4MzIsImV4cCI6MjA1MDEwOTgzMn0.sV_S_nL6i915LIn5InV6eGhjdnN0Y3Vyb2RxeXl3';
    
    // On utilise un nom de variable unique pour √©viter toute erreur
    const db = supabase.createClient(S_URL, S_KEY);

    let monPrenom = "";
    let monPass = "";
    let idGroupeActuel = null;

    async function actionLogin() {
        const n = document.getElementById('user-name').value;
        const p = document.getElementById('user-pass').value;
        if(!n || !p) return alert("Pr√©nom et mot de passe requis !");
        monPrenom = n;
        monPass = p;
        document.getElementById('welcome-txt').innerText = "Salut " + n + " !";
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        await actionLoadGroups();
    }

    async function actionLoadGroups() {
        const { data, error } = await db.from('groups').select('*');
        const container = document.getElementById('groups-container');
        if(error) { container.innerText = "Erreur de base de donn√©es."; return; }
        container.innerHTML = (data && data.length) ? "" : "Aucun groupe cr√©√©.";
        if(data) data.forEach(g => {
            container.innerHTML += `<div class="group-item"><span>${g.name}</span><button onclick="actionOpenGroup('${g.id}', '${g.name}')" style="background:var(--green); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer">Entrer</button></div>`;
        });
    }

    async function actionCreateGroup() {
        const nom = document.getElementById('group-name-input').value;
        if(!nom) return;
        const { error } = await db.from('groups').insert([{ name: nom }]);
        if(error) { alert("Erreur : " + error.message); return; }
        document.getElementById('group-name-input').value = "";
        await actionLoadGroups();
    }

    async function actionOpenGroup(id, nom) {
        idGroupeActuel = id;
        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('group-view').classList.remove('hidden');
        document.getElementById('current-group-name').innerText = nom;
        document.getElementById('result-display').innerText = "";
        await actionLoadParticipants();
    }

    function actionShowMain() {
        document.getElementById('group-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        actionLoadGroups();
    }

    async function actionJoinGroup() {
        const { error } = await db.from('participants').insert([{ 
            group_id: idGroupeActuel, 
            name: monPrenom, 
            user_password: monPass 
        }]);
        if(error) alert("Tu es d√©j√† inscrit ou il y a un probl√®me.");
        await actionLoadParticipants();
    }

    async function actionLoadParticipants() {
        const { data } = await db.from('participants').select('name').eq('group_id', idGroupeActuel);
        document.getElementById('participants-list').innerText = "Inscrits : " + (data ? data.map(p => p.name).join(', ') : "");
    }

    async function actionRevealSecret() {
        const { data } = await db.from('participants').select('*').eq('group_id', idGroupeActuel);
        if(!data || data.length < 3) return alert("Il faut au moins 3 inscrits !");
        
        const moi = data.find(p => p.name === monPrenom);
        if(!moi) return alert("Inscris-toi d'abord !");
        if(moi.user_password !== monPass) return alert("Mot de passe incorrect !");

        let noms = data.map(p => p.name).sort();
        let cibles = [...noms];
        cibles.push(cibles.shift());
        
        const indexMoi = noms.indexOf(monPrenom);
        document.getElementById('result-display').innerHTML = "Cadeau pour :<br>üéÅ <strong>" + cibles[indexMoi] + "</strong> üéÅ";
    }

    // --- NEIGE ---
    const canvas = document.getElementById('snow');
    const ctx = canvas.getContext('2d');
    let flakes = [];
    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        flakes = []; for(let i=0; i<100; i++) flakes.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*3+1, d: Math.random()+0.5});
    }
    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle = "white"; ctx.beginPath();
        flakes.forEach(f => { ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); f.y += f.d; if(f.y > canvas.height) f.y = -10; });
        ctx.fill(); requestAnimationFrame(draw);
    }
    init(); draw();
</script>
</body>
</html>
