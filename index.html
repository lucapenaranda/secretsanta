<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No√´l Secret - Connexion</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --red: #b33939; --green: #218c74; --gold: #ccae62; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; color: #333; padding: 30px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 4px solid var(--red); }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 10px; }
        .btn-red { background: var(--red); color: white; }
        .btn-green { background: var(--green); color: white; }
        .hidden { display: none; }
        .group-item { background: #f1f2f6; padding: 10px; margin: 10px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="card">
    <div id="login-view">
        <h1 style="color: var(--red);">üéÖ Connexion</h1>
        <input type="text" id="user-name" placeholder="Ton Pr√©nom">
        <input type="password" id="user-pass" placeholder="Mot de passe secret">
        <button class="btn btn-red" onclick="login()">Entrer dans la Maison</button>
    </div>

    <div id="main-view" class="hidden">
        <h2 id="welcome-txt">Salut !</h2>
        <hr>
        <h3>Cr√©er un groupe</h3>
        <input type="text" id="group-name-input" placeholder="Nom du groupe">
        <button class="btn btn-red" onclick="createGroup()">Cr√©er</button>
        <hr>
        <h3>Rejoindre un Secret Santa</h3>
        <div id="groups-container">Chargement...</div>
    </div>

    <div id="group-view" class="hidden">
        <button onclick="showMain()" style="border:none; background:none; color:var(--red); cursor:pointer;">‚Üê Retour</button>
        <h2 id="current-group-name">Groupe</h2>
        <div id="participants-list" style="margin-bottom: 20px;"></div>
        <button class="btn btn-green" onclick="joinGroup()">S'inscrire √† ce tirage</button>
        <button class="btn btn-red" onclick="revealSecret()" style="margin-top: 20px;">Voir mon tirage</button>
        <p id="result-display" style="font-weight:bold; color:var(--green); margin-top:10px;"></p>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const supabaseUrl = 'TON_URL_ICI';
    const supabaseKey = 'TA_CLE_ANON_ICI';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let me = { name: "", pass: "" };
    let currentGroupId = null;

    // --- LOGIQUE ---
    function login() {
        const name = document.getElementById('user-name').value;
        const pass = document.getElementById('user-pass').value;
        if(!name || !pass) return alert("Remplis tout !");
        me = { name, pass };
        document.getElementById('welcome-txt').innerText = "Salut " + name + " ! üéÑ";
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
        loadGroups();
    }

    async function loadGroups() {
        const { data } = await supabase.from('groups').select('*');
        const container = document.getElementById('groups-container');
        container.innerHTML = "";
        data.forEach(g => {
            container.innerHTML += `<div class="group-item">
                <span>${g.name}</span>
                <button class="btn btn-green" style="width:auto; padding:5px 10px;" onclick="openGroup('${g.id}', '${g.name}')">Entrer</button>
            </div>`;
        });
    }

    async function createGroup() {
        const name = document.getElementById('group-name-input').value;
        if(!name) return;
        await supabase.from('groups').insert([{ name }]);
        document.getElementById('group-name-input').value = "";
        loadGroups();
    }

    async function openGroup(id, name) {
        currentGroupId = id;
        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('group-view').classList.remove('hidden');
        document.getElementById('current-group-name').innerText = name;
        loadParticipants();
    }

    function showMain() {
        document.getElementById('group-view').classList.add('hidden');
        document.getElementById('main-view').classList.remove('hidden');
    }

    async function joinGroup() {
        const { error } = await supabase.from('participants').insert([{ group_id: currentGroupId, name: me.name }]);
        if(error) alert("D√©j√† inscrit !");
        loadParticipants();
    }

    async function loadParticipants() {
        const { data } = await supabase.from('participants').select('name').eq('group_id', currentGroupId);
        document.getElementById('participants-list').innerHTML = "Participants : " + data.map(p => p.name).join(', ');
    }

    async function revealSecret() {
        const { data } = await supabase.from('participants').select('name').eq('group_id', currentGroupId);
        if(data.length < 3) return alert("Il faut au moins 3 personnes !");

        // Algorithme de tirage (bas√© sur le nom de l'utilisateur)
        let participants = data.map(p => p.name).sort();
        let shuffled = [...participants];
        // On utilise une graine fixe pour que le tirage soit le m√™me pour tout le monde
        shuffled.push(shuffled.shift()); 

        const myIndex = participants.indexOf(me.name);
        if(myIndex === -1) return alert("Inscris-toi d'abord !");
        
        document.getElementById('result-display').innerText = "üéÅ Tu dois offrir √† : " + shuffled[myIndex];
    }
</script>
</body>
</html>
